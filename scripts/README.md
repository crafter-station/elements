# Scripts Documentation

## Component Preview Generation

### Overview

The `generate-preview-map.ts` script automatically generates component preview mappings based on registry conventions. This eliminates the need for manual component import mapping.

### Convention-Based System

The script follows these conventions to determine which components are previewable:

#### Previewable Component Types

1. **`registry:ui`** - Always previewable
   - These are standalone UI components
   - Example: `theme-switcher-button`, `uploadthing-button`

2. **`registry:block`** with `registry:component` files - Previewable
   - Blocks that contain UI component files
   - Example: `polar-sponsorship` (has `sponsor-tiers.tsx` component)

#### Non-Previewable Component Types

- **`registry:lib`** - Library/utility code (e.g., middleware, API routes)
- **`registry:hook`** - React hooks
- **`registry:page`** - Page components
- **`registry:block`** without component files - Meta-packages/bundles

### How It Works

1. **Scans all provider registries** (`packages/*/registry.json`)
2. **Identifies previewable components** based on type conventions
3. **Generates static imports** that Next.js can analyze at build time
4. **Creates mapping** in `apps/web/lib/component-preview-map.generated.tsx`

### Usage

```bash
# Manually generate preview map
npm run preview:generate

# Automatically runs during build
npm run build
```

### Build Integration

The script is integrated into the build process via `turbo.json`:

```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build", "//#registry:merge", "//#preview:generate"]
    },
    "//#preview:generate": {
      "cache": false,
      "outputs": ["apps/web/lib/component-preview-map.generated.tsx"]
    }
  }
}
```

### Adding New Components

To add a new previewable component:

1. Add component to your provider's `registry.json`
2. Set appropriate `type`:
   - `registry:ui` for standalone components
   - `registry:block` for component blocks
3. Ensure component files have `type: "registry:component"`
4. Run `npm run preview:generate` (or it runs automatically on build)

**No manual code changes needed!** The system automatically detects and imports your component.

### Example Registry Entry

```json
{
  "name": "my-button",
  "type": "registry:ui",
  "files": [
    {
      "path": "registry/default/my-provider/my-button/button.tsx",
      "type": "registry:component"
    }
  ]
}
```

This will automatically:
- Be detected as previewable
- Generate import: `import * as MyButtonModule from "@registry/my-provider/my-button/button"`
- Be available on provider pages at `/l/my-provider`

### Generated File

The generated file (`component-preview-map.generated.tsx`) contains:

1. **Static imports** for all previewable components
2. **Component mapping** object with component names as keys
3. **Helper function** `getPreviewComponent()` to extract exports

**⚠️ DO NOT EDIT THIS FILE MANUALLY** - It's auto-generated and will be overwritten.

### Path Alias Mapping

The script respects TypeScript path aliases defined in `apps/web/tsconfig.json`:

```json
{
  "paths": {
    "@registry/clerk/*": ["../../packages/clerk/registry/clerk/*"],
    "@registry/theme/*": ["../../packages/theme/registry/theme-switcher/*"],
    "@registry/polar/*": ["../../packages/polar/registry/polar/*"],
    // etc.
  }
}
```

### Troubleshooting

If components aren't appearing:

1. Check `type` in registry.json matches conventions
2. Ensure files have correct `type: "registry:component"`
3. Run `npm run preview:generate` to see verbose output
4. Check generated file for your component import

### Related Files

- **Script**: `scripts/generate-preview-map.ts`
- **Generated**: `apps/web/lib/component-preview-map.generated.tsx`
- **Consumer**: `apps/web/app/l/[provider]/page.tsx`
- **Config**: `turbo.json`, `package.json`
